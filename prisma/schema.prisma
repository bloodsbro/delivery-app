// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  active
  inactive
  blocked
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum StatusType {
  order
  delivery
  courier
}

enum VehicleType {
  car
  motorcycle
  bicycle
  truck
  scooter
}

enum VehicleStatus {
  active
  inactive
  maintenance
}

enum CourierAvailability {
  available
  busy
  offline
}

enum RouteStatus {
  planned
  in_progress
  completed
  cancelled
}

enum RoutePointType {
  pickup
  delivery
}

enum RoutePointStatus {
  pending
  completed
  skipped
}

enum NotificationType {
  email
  sms
  push
  in_app
}

model User {
  id            String     @id @default(uuid()) @map("id") // UUID (PK)
  email         String     @unique @db.VarChar(255) // VARCHAR(255) UNIQUE NOT NULL
  password_hash String     @db.VarChar(255) // VARCHAR(255) NOT NULL
  first_name    String     @db.VarChar(100) // VARCHAR(100) NOT NULL
  last_name     String     @db.VarChar(100) // VARCHAR(100) NOT NULL
  phone         String?    @db.VarChar(20) // VARCHAR(20)
  role_id       String // UUID (FK -> roles.id)
  status        UserStatus // ENUM ('active', 'inactive', 'blocked')
  last_login    DateTime?  @db.Timestamptz(6) // TIMESTAMP
  created_at    DateTime   @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at    DateTime   @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  role          Role           @relation(fields: [role_id], references: [id])
  customer      Customer? // Зворотній зв'язок 1:1 з Customer
  courier       Courier? // Зворотній зв'язок 1:1 з Courier
  notifications Notification[] // Зворотній зв'язок 1:N з Notification
  logs          Log[] // Зворотній зв'язок 1:N з Log

  @@map("users")
}

model Role {
  id          String   @id @default(uuid()) @map("id") // UUID (PK)
  name        String   @unique @db.VarChar(50) // VARCHAR(50) UNIQUE NOT NULL
  description String? // TEXT
  permissions Json? // JSONB
  created_at  DateTime @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at  DateTime @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  users User[] // Зворотній зв'язок 1:N з User

  @@map("roles")
}

model Customer {
  id                     String   @id @default(uuid()) @map("id") // UUID (PK)
  user_id                String   @unique // UUID (FK -> users.id) - Унікальний для 1:1 зв'язку
  company_name           String?  @db.VarChar(255) // VARCHAR(255)
  address                String? // TEXT
  zip_code               String?  @db.VarChar(20) // VARCHAR(20)
  city                   String?  @db.VarChar(100) // VARCHAR(100)
  country                String?  @db.VarChar(100) // VARCHAR(100)
  tax_id                 String?  @db.VarChar(50) // VARCHAR(50)
  default_payment_method String?  @db.VarChar(50) // VARCHAR(50)
  notes                  String? // TEXT
  created_at             DateTime @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at             DateTime @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  user   User    @relation(fields: [user_id], references: [id]) // Зв'язок 1:1 з User
  orders Order[] // Зворотній зв'язок 1:N з Order

  @@map("customers")
}

model Order {
  id                         String        @id @default(uuid()) @map("id") // UUID (PK)
  order_number               String        @unique @db.VarChar(50) // VARCHAR(50) UNIQUE NOT NULL
  customer_id                String // UUID (FK -> customers.id)
  status_id                  String // UUID (FK -> statuses.id)
  pickup_address             String // TEXT NOT NULL
  pickup_latitude            Decimal?      @db.Decimal(10, 8) // DECIMAL(10, 8)
  pickup_longitude           Decimal?      @db.Decimal(11, 8) // DECIMAL(11, 8)
  pickup_contact_name        String?       @db.VarChar(255) // VARCHAR(255)
  pickup_contact_phone       String?       @db.VarChar(20) // VARCHAR(20)
  pickup_time_window_start   DateTime?     @db.Timestamptz(6) // TIMESTAMP
  pickup_time_window_end     DateTime?     @db.Timestamptz(6) // TIMESTAMP
  delivery_address           String // TEXT NOT NULL
  delivery_latitude          Decimal?      @db.Decimal(10, 8) // DECIMAL(10, 8)
  delivery_longitude         Decimal?      @db.Decimal(11, 8) // DECIMAL(11, 8)
  delivery_contact_name      String?       @db.VarChar(255) // VARCHAR(255)
  delivery_contact_phone     String?       @db.VarChar(20) // VARCHAR(20)
  delivery_time_window_start DateTime?     @db.Timestamptz(6) // TIMESTAMP
  delivery_time_window_end   DateTime?     @db.Timestamptz(6) // TIMESTAMP
  items                      Json? // JSONB
  weight                     Decimal?      @db.Decimal(10, 2) // DECIMAL(10, 2)
  volume                     Decimal?      @db.Decimal(10, 2) // DECIMAL(10, 2)
  special_instructions       String? // TEXT
  priority                   Int           @default(0) // INTEGER DEFAULT 0
  price                      Decimal?      @db.Decimal(10, 2) // DECIMAL(10, 2)
  payment_status             PaymentStatus // ENUM ('pending', 'paid', 'failed', 'refunded')
  created_at                 DateTime      @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at                 DateTime      @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  customer     Customer     @relation(fields: [customer_id], references: [id])
  status       Status       @relation(fields: [status_id], references: [id])
  delivery     Delivery? // Зворотній зв'язок 1:1 з Delivery
  route_points RoutePoint[] // Зворотній зв'язок 1:N з RoutePoint

  @@map("orders")
}

model Status {
  id          String     @id @default(uuid()) @map("id") // UUID (PK)
  name        String     @unique @db.VarChar(50) // VARCHAR(50) UNIQUE NOT NULL
  description String? // TEXT
  type        StatusType // ENUM ('order', 'delivery', 'courier')
  color       String?    @db.VarChar(7) // VARCHAR(7)
  is_final    Boolean    @default(false) // BOOLEAN DEFAULT FALSE
  created_at  DateTime   @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at  DateTime   @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  orders     Order[] // Зворотній зв'язок 1:N з Order
  couriers   Courier[] // Зворотній зв'язок 1:N з Courier
  deliveries Delivery[] // Зворотній зв'язок 1:N з Delivery

  @@map("statuses")
}

model Courier {
  id                   String              @id @default(uuid()) @map("id") // UUID (PK)
  user_id              String              @unique // UUID (FK -> users.id) - Унікальний для 1:1 зв'язку
  vehicle_id           String? // UUID (FK -> vehicles.id)
  status_id            String // UUID (FK -> statuses.id)
  current_latitude     Decimal?            @db.Decimal(10, 8) // DECIMAL(10, 8)
  current_longitude    Decimal?            @db.Decimal(11, 8) // DECIMAL(11, 8)
  last_location_update DateTime?           @db.Timestamptz(6) // TIMESTAMP
  availability         CourierAvailability // ENUM ('available', 'busy', 'offline')
  max_weight           Decimal?            @db.Decimal(10, 2) // DECIMAL(10, 2)
  max_volume           Decimal?            @db.Decimal(10, 2) // DECIMAL(10, 2)
  rating               Decimal?            @db.Decimal(3, 2) // DECIMAL(3, 2)
  working_hours_start  DateTime?           @db.Timestamptz(6) // TIME (Mapped to DateTime in Prisma)
  working_hours_end    DateTime?           @db.Timestamptz(6) // TIME (Mapped to DateTime in Prisma)
  working_days         Json? // JSONB
  created_at           DateTime            @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at           DateTime            @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  user       User       @relation(fields: [user_id], references: [id]) // Зв'язок 1:1 з User
  vehicle    Vehicle?   @relation(fields: [vehicle_id], references: [id])
  status     Status     @relation(fields: [status_id], references: [id])
  deliveries Delivery[] // Зворотній зв'язок 1:N з Delivery
  routes     Route[] // Зворотній зв'язок 1:N з Route

  @@map("couriers")
}

model Vehicle {
  id            String        @id @default(uuid()) @map("id") // UUID (PK)
  type          VehicleType // ENUM ('car', 'motorcycle', 'bicycle', 'truck', 'scooter')
  make          String?       @db.VarChar(100) // VARCHAR(100)
  model         String?       @db.VarChar(100) // VARCHAR(100)
  year          Int? // INTEGER
  license_plate String?       @db.VarChar(20) // VARCHAR(20)
  color         String?       @db.VarChar(50) // VARCHAR(50)
  max_weight    Decimal?      @db.Decimal(10, 2) // DECIMAL(10, 2)
  max_volume    Decimal?      @db.Decimal(10, 2) // DECIMAL(10, 2)
  features      Json? // JSONB
  status        VehicleStatus // ENUM ('active', 'inactive', 'maintenance')
  current_latitude     Decimal?      @db.Decimal(10, 8) // DECIMAL(10, 8)
  current_longitude    Decimal?      @db.Decimal(11, 8) // DECIMAL(11, 8)
  last_location_update DateTime?     @db.Timestamptz(6) // TIMESTAMP
  created_at    DateTime      @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at    DateTime      @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  couriers Courier[] // Зворотній зв'язок 1:N з Courier

  @@map("vehicles")
}

model Delivery {
  id                   String    @id @default(uuid()) @map("id") // UUID (PK)
  order_id             String    @unique // UUID (FK -> orders.id) - Унікальний для 1:1 зв'язку
  courier_id           String // UUID (FK -> couriers.id)
  status_id            String // UUID (FK -> statuses.id)
  route_id             String? // UUID (FK -> routes.id)
  start_time           DateTime? @db.Timestamptz(6) // TIMESTAMP
  end_time             DateTime? @db.Timestamptz(6) // TIMESTAMP
  actual_pickup_time   DateTime? @db.Timestamptz(6) // TIMESTAMP
  actual_delivery_time DateTime? @db.Timestamptz(6) // TIMESTAMP
  distance             Decimal?  @db.Decimal(10, 2) // DECIMAL(10, 2)
  duration             Int? // INTEGER
  notes                String? // TEXT
  proof_of_delivery    Json? // JSONB
  rating               Int? // INTEGER
  feedback             String? // TEXT
  created_at           DateTime  @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at           DateTime  @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  order   Order   @relation(fields: [order_id], references: [id]) // Зв'язок 1:1 з Order
  courier Courier @relation(fields: [courier_id], references: [id])
  status  Status  @relation(fields: [status_id], references: [id])
  route   Route?  @relation(fields: [route_id], references: [id])

  @@map("deliveries")
}

model Route {
  id             String      @id @default(uuid()) @map("id") // UUID (PK)
  name           String?     @db.VarChar(255) // VARCHAR(255)
  courier_id     String // UUID (FK -> couriers.id)
  status         RouteStatus // ENUM ('planned', 'in_progress', 'completed', 'cancelled')
  start_time     DateTime?   @db.Timestamptz(6) // TIMESTAMP
  end_time       DateTime?   @db.Timestamptz(6) // TIMESTAMP
  total_distance Decimal?    @db.Decimal(10, 2) // DECIMAL(10, 2)
  total_duration Int? // INTEGER
  path           String? // GEOGRAPHY(LINESTRING) - Зберігається як String, обробка геометрії на рівні застосунку
  created_at     DateTime    @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at     DateTime    @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  courier      Courier      @relation(fields: [courier_id], references: [id])
  deliveries   Delivery[] // Зворотній зв'язок 1:N з Delivery
  route_points RoutePoint[] // Зворотній зв'язок 1:N з RoutePoint

  @@map("routes")
}

model RoutePoint {
  id           String           @id @default(uuid()) @map("id") // UUID (PK)
  route_id     String // UUID (FK -> routes.id)
  order_id     String // UUID (FK -> orders.id)
  type         RoutePointType // ENUM ('pickup', 'delivery')
  sequence     Int // INTEGER NOT NULL
  address      String // TEXT NOT NULL
  latitude     Decimal?         @db.Decimal(10, 8) // DECIMAL(10, 8)
  longitude    Decimal?         @db.Decimal(11, 8) // DECIMAL(11, 8)
  planned_time DateTime?        @db.Timestamptz(6) // TIMESTAMP
  actual_time  DateTime?        @db.Timestamptz(6) // TIMESTAMP
  status       RoutePointStatus // ENUM ('pending', 'completed', 'skipped')
  notes        String? // TEXT
  created_at   DateTime         @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at   DateTime         @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  route Route @relation(fields: [route_id], references: [id])
  order Order @relation(fields: [order_id], references: [id])

  @@map("route_points")
}

model Notification {
  id                  String           @id @default(uuid()) @map("id") // UUID (PK)
  user_id             String // UUID (FK -> users.id)
  type                NotificationType // ENUM ('email', 'sms', 'push', 'in_app')
  title               String           @db.VarChar(255) // VARCHAR(255) NOT NULL
  content             String // TEXT NOT NULL
  related_entity_type String?          @db.VarChar(50) // VARCHAR(50)
  related_entity_id   String? // UUID
  is_read             Boolean          @default(false) // BOOLEAN DEFAULT FALSE
  sent_at             DateTime?        @db.Timestamptz(6) // TIMESTAMP
  read_at             DateTime?        @db.Timestamptz(6) // TIMESTAMP
  created_at          DateTime         @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL
  updated_at          DateTime         @updatedAt @db.Timestamptz(6) // TIMESTAMP NOT NULL

  user User @relation(fields: [user_id], references: [id])

  @@map("notifications")
}

model Log {
  id          String   @id @default(uuid()) @map("id") // UUID (PK)
  user_id     String? // UUID (FK -> users.id) - Може бути null для системних логів
  action      String   @db.VarChar(255) // VARCHAR(255) NOT NULL
  entity_type String?  @db.VarChar(50) // VARCHAR(50)
  entity_id   String? // UUID
  data        Json? // JSONB
  ip_address  String?  @db.VarChar(45) // VARCHAR(45)
  user_agent  String? // TEXT
  created_at  DateTime @default(now()) @db.Timestamptz(6) // TIMESTAMP NOT NULL

  user User? @relation(fields: [user_id], references: [id])

  @@map("logs")
}
